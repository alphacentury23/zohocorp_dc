# CVE-2020-24397

An issue was discovered in the client side of [Zoho ManageEngine Desktop Central](https://www.manageengine.com/products/desktop-central/) 10.0.0.SP-534. An attacker-controlled server can trigger an integer overflow in InternetSendRequestEx and InternetSendRequestByBitrate that leads to a heap-based buffer overflow and Remote Code Execution with SYSTEM privileges (unauthenticated RCE if combined with exploitation of CVE-2020-15589). This vulnerability is the result of an incorrect fix for [CVE-2020-15588](https://nvd.nist.gov/vuln/detail/CVE-2020-15588).

```
"Desktop Central is a unified endpoint management (UEM) solution that helps in managing servers, laptops, desktops, smartphones, and tablets from a central location. It's a modern take on desktop management that can be scaled as per organizational needs.

Desktop Central augments a traditional desktop management service, offering more depth and customization. Automate regular endpoint management routines like installing patches, deploying software, imaging and deploying OS. In addition, it also lets you manage assets & software licenses, monitor software usage statistics, manage USB device usage, take control of remote desktops, and more."
```

In periodic intervals, Desktop Central clients ("agents") attempt to contact their designated server via HTTPS on TCP port 8383 in standard configurations. In order to send POST requests, affected clients call a function InternetSendRequestEx or InternetSendRequestByBitrate that also parses the server's response. If a response contains a Content-Length header, it is processed by the client and used to calculate the size of a heap buffer as follows:

``` c
DWORD size_buffer;
DWORD content_length;

size_buffer = content_length + 5;
```
Given that the Content-Length header (and thus "content_length") can be set arbitrarily by a server, the above expression will int-overflow if "content_length" exceeds 0xFFFFFFFA.
This will lead to allocation of a small heap buffer, which can be overflowed by attackers through a subsequent call to WinHttpReadData().

The vulnerability looks as follows:
``` c
// read Content-Length from HTTP header
if ( WinHttpQueryHeaders(hRequest, 0x20000005u, 0, &content_length, &dwBufferLength, 0) )
{
    // size_buffer will integer overflow
    size_buffer = 4 * (content_length + 2) + 4;
    content_length += 2;
    // allocate small heap buffer
    heap_buf = (WCHAR *)calloc(1u, size_buffer);
    lpdwNumberOfBytesRead = &dwNumberOfBytesRead;
    *out = (int)heap_buf;
    // heap overflow!
    if ( WinHttpReadData(hRequest, heap_buf, content_length, lpdwNumberOfBytesRead) )
```

Due to periodic requests sent by various Desktop Central client modules (of which most run with SYSTEM privileges), no user interaction will be required for exploitation. Attackers may exploit this vulnerability by either running a malicious Desktop Central server or by impersonating a legit server by conducting Man-in-the-Middle attacks on HTTPS connections ([CVE-2020-15589](https://nvd.nist.gov/vuln/detail/CVE-2020-15589)).

List of affected modules:
```
dcagentservice.exe
dcagent.dll
dcconfig.exe
dcagentupgrader.exe
dcagenttrayicon.exe
dcannouncement.exe
dcappcontrol.exe
dcchat.exe
dcfilescan.exe
dcfilesystem.exe
dcinventory.exe
dcmsghandler.exe
dcondemand.exe
dcpatchscan.exe
dcrdservice.exe
dcremregistry.exe
dcstatusutil.exe
dcswmeter.exe
dctoolseventviewer.exe
dcuninstallsw.exe
dcupload.exe
dcusbsummary.exe
dcwol.exe
selfservicedll.dll
```

```
Disclosure Timeline:
2020-08-18 - Vulnerability reported to vendor (as a result of an incorrectly fixed CVE-2020-15588)
2020-08-28 - Vulnerability acknowledged by vendor
2020-10-05 - Public Disclosure (fix available, in reference to https://www.manageengine.com/products/desktop-central/integer-overflow-vulnerability.html)
```