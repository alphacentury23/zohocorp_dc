# CVE-2020-15588

An issue was discovered in the client side of [Zoho ManageEngine Desktop Central](https://www.manageengine.com/products/desktop-central/) 10.0.552.W. An attacker-controlled server can trigger an integer overflow in InternetSendRequestEx and InternetSendRequestByBitrate that leads to a heap-based buffer overflow and Remote Code Execution with SYSTEM privileges (unauthenticated RCE if combined with exploitation of CVE-2020-15589).

```
"Desktop Central is a unified endpoint management (UEM) solution that helps in managing servers, laptops, desktops, smartphones, and tablets from a central location. It's a modern take on desktop management that can be scaled as per organizational needs.

Desktop Central augments a traditional desktop management service, offering more depth and customization. Automate regular endpoint management routines like installing patches, deploying software, imaging and deploying OS. In addition, it also lets you manage assets & software licenses, monitor software usage statistics, manage USB device usage, take control of remote desktops, and more."
```

In periodic intervals, Desktop Central clients ("agents") attempt to contact their designated server via HTTPS on TCP port 8383 in standard configurations. In order to send POST requests, affected clients call a function InternetSendRequestEx or InternetSendRequestByBitrate that also parses the server's response. If a response contains a Content-Length header, it is processed by the client and used to calculate the size of a heap buffer as follows:

``` c
DWORD size_buffer;
DWORD content_length;

size_buffer = 4 * (content_length + 2) + 4;
```
Given that the Content-Length header (and thus "content_length") can be set arbitrarily by a server, the above expression will int-overflow if "content_length" exceeds 0x3FFFFFFD.
This will lead to allocation of a small heap buffer, which can be overflowed by attackers through a subsequent call to WinHttpReadData().

The vulnerability looks as follows:
``` c
// read Content-Length from HTTP header
if ( WinHttpQueryHeaders(hRequest, 0x20000005u, 0, &content_length, &dwBufferLength, 0) )
{
    // size_buffer will integer overflow
    size_buffer = 4 * (content_length + 2) + 4;
    content_length += 2;
    // allocate small heap buffer
    heap_buf = (WCHAR *)calloc(1u, size_buffer);
    lpdwNumberOfBytesRead = &dwNumberOfBytesRead;
    *out = (int)heap_buf;
    // heap overflow!
    if ( WinHttpReadData(hRequest, heap_buf, content_length, lpdwNumberOfBytesRead) )
```
Successful exploitation will grant attackers Remote Code Execution with SYSTEM privileges on Windows systems running ManageEngine Desktop Central agents (unauthenticated RCE if combined with exploitation of CVE-2020-15589).
Due to periodic requests sent by various Desktop Central client modules (of which most run with SYSTEM privileges), no user interaction will be required for exploitation. Attackers may exploit this vulnerability by either running a malicious Desktop Central server or by impersonating a legit server by conducting Man-in-the-Middle attacks on HTTPS connections (CVE-2020-15589).

List of affected modules:
```
dcagentservice.exe
dcagent.dll
dcconfig.exe
dcagentupgrader.exe
dcagenttrayicon.exe
dcannouncement.exe
dcappcontrol.exe
dcchat.exe
dcfilescan.exe
dcfilesystem.exe
dcinventory.exe
dcmsghandler.exe
dcondemand.exe
dcpatchscan.exe
dcrdservice.exe
dcremregistry.exe
dcstatusutil.exe
dcswmeter.exe
dctoolseventviewer.exe
dcuninstallsw.exe
dcupload.exe
dcusbsummary.exe
dcwol.exe
selfservicedll.dll
```

List of monitored API functions called by a vulnerable component (dcconfig.exe) during exploitation:

``` 
#	Time of Day	Thread	Module	API	Return Value	Error	Duration
370100	10:24:13.764 PM	1	dcconfig.exe	WinHttpReceiveResponse ( 0x00c36968, NULL )	TRUE		0.0000109
370101	10:24:13.764 PM	1	dcconfig.exe	WinHttpQueryHeaders ( 0x00c36968, WINHTTP_QUERY_RAW_HEADERS_CRLF, NULL, NULL, 0x0093f97c, NULL )	FALSE	122 = The data area passed to a system call is too all. 	0.0000017
370102	10:24:13.764 PM	1	dcconfig.exe	HeapAlloc ( 0x00aa0000, HEAP_ZERO_MEMORY, 2408 )	0x0252d0a0		0.0000015
370103	10:24:13.764 PM	1	dcconfig.exe	WinHttpQueryHeaders ( 0x00c36968, WINHTTP_QUERY_RAW_HEADERS_CRLF, NULL, 0x0252d0a0, 0x0093f97c, NULL )	TRUE		0.0000023
370104	10:24:13.764 PM	1	dcconfig.exe	WinHttpQueryHeaders ( 0x00c36968, WINHTTP_QUERY_STATUS_CODE | WINHTTP_QUERY_FLAG_NUMBER, NULL, 0x0093f948, 0x0093f97c, NULL )	TRUE		0.0000004
370113	10:24:13.764 PM	1	dcconfig.exe	WinHttpQueryHeaders ( 0x00c36968, WINHTTP_QUERY_CONTENT_LENGTH | WINHTTP_QUERY_FLAG_NUMBER, NULL, 0x0093f954, 0x0093f97c, NULL )	TRUE		0.0000007
370114	10:24:13.764 PM	1	dcconfig.exe	HeapAlloc ( 0x00aa0000, HEAP_ZERO_MEMORY, 36 )	0x024786d8		0.0000003   <--- allocate buffer of 36 bytes in size -> returns 0x024786d8
370115	10:24:13.764 PM	1	dcconfig.exe	WinHttpReadData ( 0x00c36968, 0x024786d8, 1073741832, 0x0093f950 )			       <--- read up to 1073741832 of characters into buffer @0x024786d8
370116	10:24:13.764 PM	8	dcconfig.exe	HeapAlloc ( 0x00aa0000, HEAP_ZERO_MEMORY, 28 )			
370117	10:24:13.764 PM	8	dcconfig.exe	HeapAlloc ( 0x00aa0000, HEAP_ZERO_MEMORY, 28 )	0x02453378		0.0000011
370118	10:24:13.764 PM	8	dcconfig.exe	HeapAlloc ( 0x00aa0000, HEAP_ZERO_MEMORY, 4 )	0x02469820		0.0000004
370119	10:24:13.764 PM	8	dcconfig.exe	HeapAlloc ( 0x00aa0000, HEAP_ZERO_MEMORY, 532 )
```

As a result of the PoC exploit's hard-coded Content-Length header (1073741830), a heap buffer (address 0x02453378) with a size of 36 bytes is allocated. A subsequent call to WinHttpReadData() reads up to 1073741832 number of bytes into this buffer, however.

```
Disclosure Timeline:
2020-07-04 - Vulnerability reported to vendor
2020-07-18 - Vulnerability acknowledged by vendor
2020-07-29 - Fix published by vendor
2020-08-18 - Informed vendor that the vulnerability hasn't been fixed correctly
2020-08-27 - Requested new CVE ID (CVE-2020-24397)
2020-10-05 - Public Disclosure (fix available, in reference to https://www.manageengine.com/products/desktop-central/integer-overflow-vulnerability.html)
```
